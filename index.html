<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMA V.2 - AI Sale Assistant (Secured & Optimized)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        .animate-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        
        .slide-in-from-bottom {
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        @keyframes slideInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #0f172a;
        }
        
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .markdown-content li {
            margin-bottom: 0.5rem;
        }
        
        .markdown-content strong {
            font-weight: 700;
            color: #0f172a;
        }
        
        /* Popup styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .popup-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        @media (max-width: 768px) {
            .mobile-fix {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow: hidden;
            }
        }
        
        /* Passcode input style */
        .passcode-input {
            letter-spacing: 0.5em;
            text-align: center;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Component mount/unmount animations */
        .component-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .component-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        
        .component-exit {
            opacity: 1;
        }
        
        .component-exit-active {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 300ms, transform 300ms;
        }
        
        /* Loading animation */
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root" class="min-h-screen"></div>
    
    <!-- Popup for Non-AI system warning -->
    <div id="non-ai-popup" class="popup-overlay hidden">
        <div class="popup-content">
            <h3 class="text-lg font-bold text-slate-800 mb-4">ระบบนี้ไม่มีการประมวลผลด้วย AI</h3>
            <p class="text-slate-600 mb-6">คุณกำลังจะเข้าสู่ระบบที่ทำงานโดยไม่มี AI กรุณาตรวจสอบให้แน่ใจว่านี่คือสิ่งที่คุณต้องการ</p>
            <div class="flex gap-3 justify-end">
                <button id="cancel-non-ai" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">
                    Cancel
                </button>
                <button id="confirm-non-ai" class="px-4 py-2 bg-gradient-to-r from-sky-600 to-indigo-600 text-white font-bold rounded-lg hover:from-sky-700 hover:to-indigo-700">
                    Ok! Let's go
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ตั้งค่า Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans Thai', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#0ea5e9',
                        'secondary': '#6366f1',
                    }
                }
            }
        };

        // --- Enhanced Regional Data Schema ---
        const RH_DATA = {
            "RH1": {
                name: "RH1: กรุงเทพฯ & ปริมณฑล",
                zones: ["จตุจักร", "ธนบุรี", "บางกะปิ", "สาทร", "สุขุมวิท"],
                dynamics: "สังคมเมือง เร่งรีบ แข่งขันสูง ค่าครองชีพสูงที่สุด",
                keywords: ["ภาษีสังคม", "ค่าเสียเวลา", "ความคุ้มครองระดับพรีเมียม", "มรดกที่จับต้องได้"],
                hospitals: ["บำรุงราษฎร์", "สมิติเวช สุขุมวิท", "กรุงเทพ", "พญาไท 2"],
                tone: "Professional, กระชับ, เน้นตัวเลขและผลตอบแทน",
                context: "เน้นการบริหารภาษี และการรักษาที่รวดเร็วใน รพ. ระดับ World Class"
            },
            "RH2": {
                name: "RH2: ภาคตะวันออก (EEC)",
                zones: ["ชลบุรี", "บางนา", "พัทยา", "ระยอง"],
                dynamics: "เขตเศรษฐกิจใหม่ นิคมอุตสาหกรรม เมืองท่องเที่ยว รายได้สูงแต่มีความเสี่ยง",
                keywords: ["ความเสี่ยงจากการทำงาน", "เงินก้อนหลังเกษียณไว", "สวัสดิการโรงงาน", "สวัสดิการเสริม"],
                hospitals: ["กรุงเทพพัทยา", "สมิติเวช ศรีราชา", "พญาไท ศรีราชา"],
                tone: "จริงใจ, เน้นความคุ้มค่า, ตรงไปตรงมา",
                context: "เน้นการสร้างรายได้เสริมจากสวัสดิการเดิมที่ไม่ครอบคลุมหลังออกจากงาน"
            },
            "RH3": {
                name: "RH3: ภาคเหนือ",
                zones: ["เชียงใหม่", "นครสวรรค์", "นนทบุรี", "พิษณุโลก", "อยุธยา"],
                dynamics: "สังคมผู้สูงอายุ วัฒนธรรมล้านนา ท่องเที่ยวเชิงวัฒนธรรม",
                keywords: ["บารมี", "ส่งต่อให้ลูกหลาน", "อยู่อย่างสง่างาม", "ความมั่นคงปลอดภัย"],
                hospitals: ["เชียงใหม่ ราม", "กรุงเทพเชียงใหม่", "ศรีพัฒน์"],
                tone: "นุ่มนวล, ให้เกียรติ, เน้นความสัมพันธ์ระยะยาว",
                context: "เน้นเรื่องมรดกและการดูแลสุขภาพในวัยเกษียณที่เป็นภาระลูกหลานให้น้อยที่สุด"
            },
            "RH4": {
                name: "RH4: ภาคตะวันออกเฉียงเหนือ",
                zones: ["ดอนเมือง", "นครราชสีมา", "สระบุรี", "อุดรธานี", "อุบลราชธานี"],
                dynamics: "ครอบครัวขยาย เกษตรกรรมก้าวหน้า เสาหลักคนสำคัญ",
                keywords: ["ความกตัญญู", "พึ่งพาตัวเองได้", "ทุนการศึกษาลูก", "ไม่เป็นภาระใคร"],
                hospitals: ["กรุงเทพขอนแก่น", "เอกอุดร", "พริ้นซ์ อุบลราชธานี"],
                tone: "เป็นกันเอง, จริงใจเหมือนญาติ, เข้าถึงง่าย",
                context: "เน้นการปกป้องเสาหลักของบ้านที่มีความรับผิดชอบต่อคนจำนวนมาก"
            },
            "RH5": {
                name: "RH5: ภาคใต้",
                zones: ["ภูเก็ต", "ราชบุรี", "สมุทรสาคร", "สุราษฎร์ธานี", "หาดใหญ่"],
                dynamics: "การประมง/สวนยาง/ท่องเที่ยว รายได้สูงเป็นช่วงเวลา",
                keywords: ["ใจนักเลง", "พวกพ้อง", "สภาพคล่อง", "การันตีรายได้"],
                hospitals: ["กรุงเทพหาดใหญ่", "กรุงเทพภูเก็ต", "สงขลานครินทร์ (SMC)"],
                tone: "หนักแน่น, ชัดเจน, จริงใจ, ไม่เยิ่นเย้อ",
                context: "เน้นการล็อกกำไรจากธุรกิจและการสร้างกระแสเงินสดที่สม่ำเสมอ"
            }
        };

        // Icon mapping
        const ICONS = {
            calculator: '<i class="fas fa-calculator text-sky-500"></i>',
            message: '<i class="fas fa-comment-dots text-indigo-500"></i>',
            shield: '<i class="fas fa-shield-alt text-amber-500"></i>',
            gift: '<i class="fas fa-gift text-emerald-500"></i>',
            bag: '<i class="fas fa-shopping-bag text-purple-500"></i>',
            file: '<i class="fas fa-file-check text-emerald-500"></i>',
            terminal: '<i class="fas fa-terminal text-slate-500"></i>',
            sparkles: '<i class="fas fa-sparkles text-amber-500"></i>',
            map: '<i class="fas fa-map-marker-alt text-rose-500"></i>',
            alert: '<i class="fas fa-exclamation-circle text-rose-500"></i>',
            building: '<i class="fas fa-building text-sky-500"></i>',
            stethoscope: '<i class="fas fa-stethoscope text-purple-500"></i>',
            lightbulb: '<i class="fas fa-lightbulb text-amber-500"></i>',
            zap: '<i class="fas fa-bolt text-amber-500"></i>',
            trending: '<i class="fas fa-chart-line text-emerald-500"></i>',
            copy: '<i class="fas fa-copy text-slate-500"></i>',
            rotate: '<i class="fas fa-redo text-slate-500"></i>',
            thumbsUp: '<i class="fas fa-thumbs-up text-emerald-500"></i>',
            thumbsDown: '<i class="fas fa-thumbs-down text-rose-500"></i>',
            share: '<i class="fas fa-share-alt text-sky-500"></i>',
            save: '<i class="fas fa-save text-sky-500"></i>',
            chevronRight: '<i class="fas fa-chevron-right"></i>',
            users: '<i class="fas fa-users text-sky-500"></i>',
            heart: '<i class="fas fa-heart text-rose-500"></i>',
            loader: '<i class="fas fa-spinner fa-spin"></i>',
            home: '<i class="fas fa-home text-sky-500"></i>',
            briefcase: '<i class="fas fa-briefcase text-amber-500"></i>',
            money: '<i class="fas fa-money-bill-wave text-emerald-500"></i>',
            hospital: '<i class="fas fa-hospital text-rose-500"></i>',
            clock: '<i class="fas fa-clock text-amber-500"></i>',
            chartPie: '<i class="fas fa-chart-pie text-purple-500"></i>',
            lock: '<i class="fas fa-lock text-amber-500"></i>'
        };

        // --- Supabase Configuration ---
        const SUPABASE_CONFIG = {
            url: 'https://wmgrfwvlrdbfmqngtuuq.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZ3Jmd3ZscmRiZm1xbmd0dXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NTU4MjYsImV4cCI6MjA4NTEzMTgyNn0.l-VMPuCfL69hcHAyd3Nw3pi1HUPlGV2Iz7AuTEO2sU4'
        };

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

        // API Key Rotation Function
        const getRotatedApiKey = async () => {
            try {
                const { data, error } = await supabase
                    .from('api_keys')
                    .select('key, usage_count, last_used')
                    .eq('status', 'active')
                    .order('last_used', { ascending: true })
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const newKey = data[0].key;
                    
                    // Update usage count async
                    supabase
                        .from('api_keys')
                        .update({ 
                            usage_count: (data[0].usage_count || 0) + 1,
                            last_used: new Date().toISOString()
                        })
                        .eq('key', newKey)
                        .catch(err => console.error('Failed to update API key usage:', err));
                    
                    return newKey;
                }
                return null;
            } catch (error) {
                console.error('Supabase error:', error);
                return null;
            }
        };

        // --- Optimized MAMA V.2 Application ---
        class MAMAV2Enhanced {
            constructor() {
                this.state = {
                    passcodeVerified: false,
                    showPasscodeForm: true,
                    currentApiKey: "",
                    isSetup: false,
                    userProfile: { rh: "", zone: "" },
                    activeTab: "ice_breaking",
                    loading: false,
                    aiResponse: "",
                    error: "",
                    feedback: null,
                    forms: {
                        ice_breaking: {
                            transaction: "",
                            insight: "",
                            disc: "D",
                            relationship_level: "",
                            common_interest: ""
                        },
                        needs_analysis: {
                            income: "",
                            tax_bracket: "10%",
                            welfare: "",
                            top_concern: "",
                            dependents: "",
                            years: "",
                            assets: "",
                            debt: ""
                        },
                        objection: {
                            real_reason: "",
                            interest_level: "5",
                            disc: "D",
                            product: "",
                            tone: ""
                        },
                        simplifier: {
                            plan_name: "",
                            benefits: "",
                            premium: "",
                            competitor_comparison: "",
                            unique_selling_point: ""
                        },
                        matchmaker: {
                            goal: "ลดหย่อนภาษี",
                            budget: "",
                            existing_coverage: "",
                            priority_level: ""
                        },
                        closing: {
                            interest_point: "",
                            last_concern: "",
                            timeline: "",
                            decision_maker: ""
                        },
                        prompt_designer: {
                            objective: "",
                            target: "",
                            tone: "Professional",
                            details: "",
                            channel: "",
                            call_to_action: ""
                        }
                    }
                };
                
                this.init();
            }
            
            setState(newState, callback) {
                // Simple state update
                Object.assign(this.state, newState);
                
                // Save to localStorage
                try {
                    const stateToSave = { ...this.state };
                    delete stateToSave.currentApiKey;
                    localStorage.setItem('mama_v2_state', JSON.stringify(stateToSave));
                } catch (e) {
                    console.warn("Could not save state to localStorage");
                }
                
                // Render
                this.render();
                
                if (callback) callback();
            }
            
            verifyPasscode(input) {
                const PASSCODE = "2026";
                return input === PASSCODE;
            }
            
            handlePasscodeSubmit(passcode) {
                if (this.verifyPasscode(passcode)) {
                    this.setState({ 
                        passcodeVerified: true,
                        showPasscodeForm: false 
                    });
                    return true;
                } else {
                    const input = document.getElementById('passcode-input');
                    if (input) {
                        input.classList.add('shake');
                        setTimeout(() => {
                            input.classList.remove('shake');
                            input.value = '';
                            input.focus();
                        }, 500);
                    }
                    return false;
                }
            }
            
            submitPasscode() {
                const passcodeInput = document.getElementById('passcode-input');
                if (passcodeInput) {
                    const passcode = passcodeInput.value;
                    if (this.handlePasscodeSubmit(passcode)) {
                        setTimeout(() => {
                            const rhSelect = document.getElementById('rh-select');
                            if (rhSelect) rhSelect.focus();
                        }, 100);
                    }
                }
            }
            
            logout() {
                this.setState({
                    passcodeVerified: false,
                    showPasscodeForm: true,
                    isSetup: false,
                    userProfile: { rh: "", zone: "" },
                    aiResponse: "",
                    error: ""
                });
                
                localStorage.removeItem('mama_v2_state');
            }
            
            // ========== RENDER METHODS ==========
            
            render() {
                const root = document.getElementById('root');
                if (!root) {
                    console.error("Root element not found!");
                    return;
                }
                
                try {
                    let html = '';
                    
                    if (!this.state.passcodeVerified) {
                        html = this.renderPasscodeForm();
                    } else if (!this.state.isSetup) {
                        html = this.renderSetupPage();
                    } else {
                        html = this.renderMainPage();
                    }
                    
                    root.innerHTML = html;
                    
                    // Attach event listeners after DOM is updated
                    setTimeout(() => this.attachEventListeners(), 10);
                    
                } catch (error) {
                    console.error("Render error:", error);
                    this.renderError(error);
                }
            }
            
            renderPasscodeForm() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-950 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 md:p-8">
                            <div class="flex flex-col items-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-br from-sky-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl">
                                    ${ICONS.shield.replace('text-amber-500', 'text-white')}
                                </div>
                                <h1 class="text-2xl font-black text-slate-900 tracking-tight">MAMA V.2</h1>
                                <p class="text-xs bg-gradient-to-r from-sky-600 to-indigo-600 bg-clip-text text-transparent font-bold tracking-[0.2em] uppercase mt-2">ACCESS VERIFICATION</p>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="text-center">
                                    <p class="text-slate-600 mb-2">กรุณากรอกรหัสผ่านเพื่อเข้าใช้งานระบบ</p>
                                    <p class="text-xs text-slate-500">ระบบนี้จำกัดการเข้าถึงสำหรับผู้ที่มีสิทธิ์เท่านั้น</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">PASSCODE</label>
                                    <input 
                                        type="password"
                                        id="passcode-input"
                                        maxlength="4"
                                        class="w-full border-2 border-slate-100 rounded-xl p-4 text-center text-2xl font-bold tracking-widest focus:border-sky-500 outline-none transition-all passcode-input"
                                        placeholder="••••"
                                        autocomplete="off"
                                        autofocus
                                    >
                                    <p class="text-xs text-slate-500 mt-2 text-center">รหัสผ่านเป็นตัวเลข 4 หลัก</p>
                                </div>
                                
                                <button 
                                    id="submit-passcode-btn"
                                    class="w-full bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-sky-900/20 active:scale-95 transform transition-transform">
                                    ตรวจสอบรหัสผ่าน ${ICONS.chevronRight}
                                </button>
                                
                                <div class="pt-4 border-t border-slate-100 text-center">
                                    <p class="text-xs text-slate-500">
                                        สำหรับเจ้าหน้าที่ ttb และพันธมิตรเท่านั้น
                                    </p>
                                    <p class="text-xs text-slate-400 mt-1">
                                        © 2024 MAMA AI Assistant v2.0
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderSetupPage() {
                const rhOptions = Object.keys(RH_DATA).map(rh => 
                    `<option value="${rh}" ${this.state.userProfile.rh === rh ? 'selected' : ''}>${rh}</option>`
                ).join('');
                
                const zoneOptions = this.state.userProfile.rh 
                    ? RH_DATA[this.state.userProfile.rh].zones.map(z => 
                        `<option value="${z}" ${this.state.userProfile.zone === z ? 'selected' : ''}>${z}</option>`
                      ).join('')
                    : '';
                
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-950 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 md:p-8">
                            <div class="flex flex-col items-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-br from-sky-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl">
                                    ${ICONS.sparkles.replace('text-amber-500', 'text-white')}
                                </div>
                                <h1 class="text-3xl font-black text-slate-900 tracking-tight">MAMA V.2</h1>
                                <p class="text-xs bg-gradient-to-r from-sky-600 to-indigo-600 bg-clip-text text-transparent font-bold tracking-[0.2em] uppercase mt-2">Enhanced AI Sale Assistant</p>
                                <div class="mt-2 text-xs text-slate-500 flex items-center gap-1">
                                    ${ICONS.lock.replace('text-amber-500', 'text-slate-400')}
                                    <span>รหัสผ่านถูกตรวจสอบแล้ว</span>
                                </div>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="text-center mb-6">
                                    <p class="text-slate-600 mb-4">ระบบนี้ใช้ Supabase สำหรับการจัดการ API Key Rotation</p>
                                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-full">
                                        ${ICONS.shield.replace('text-amber-500', 'text-slate-600')}
                                        <span class="text-sm font-medium text-slate-700">Secure API Management</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">REGION (RH)</label>
                                    <select 
                                        id="rh-select"
                                        class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none text-base">
                                        <option value="">เลือก RH</option>
                                        ${rhOptions}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">ZONE</label>
                                    <select 
                                        id="zone-select"
                                        ${!this.state.userProfile.rh ? 'disabled' : ''}
                                        class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-sky-500 outline-none text-base ${!this.state.userProfile.rh ? 'bg-slate-50' : ''}">
                                        <option value="">เลือกโซน</option>
                                        ${zoneOptions}
                                    </select>
                                </div>
                                
                                <div class="pt-4 border-t border-slate-100">
                                    <button 
                                        id="start-system-btn"
                                        class="w-full bg-gradient-to-r from-sky-600 to-indigo-600 hover:from-sky-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-sky-900/20 active:scale-95 transform transition-transform">
                                        เริ่มใช้งานระบบ ${ICONS.chevronRight}
                                    </button>
                                    
                                    <div class="mt-6 flex justify-between items-center">
                                        <button id="logout-btn" class="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                            ${ICONS.rotate}
                                            <span>ออกจากระบบ</span>
                                        </button>
                                        
                                        <button id="non-ai-btn" class="text-sm text-slate-500 hover:text-slate-700 underline">
                                            ระบบ Non-AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderInputSection() {
                const tab = this.state.activeTab;
                const f = this.state.forms[tab];
                
                const escapeHtml = (text) => {
                    if (text === undefined || text === null) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const createInput = (tabName, field, value, placeholder, type = "text") => {
                    return `
                        <input 
                            data-tab="${tabName}"
                            data-field="${field}"
                            type="${type}" 
                            class="w-full p-3 border border-slate-200 rounded-xl bg-white text-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all"
                            value="${escapeHtml(value || '')}"
                            placeholder="${placeholder}"
                            autocomplete="off"
                        >
                    `;
                };
                
                const createTextarea = (tabName, field, value, placeholder, rows = 4) => {
                    return `
                        <textarea 
                            data-tab="${tabName}"
                            data-field="${field}"
                            class="w-full p-3 border border-slate-200 rounded-xl bg-white text-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all resize-none"
                            rows="${rows}"
                            placeholder="${placeholder}"
                            autocomplete="off"
                        >${escapeHtml(value || '')}</textarea>
                    `;
                };
                
                const createSelect = (tabName, field, value, options, placeholder = "เลือก") => {
                    let optionsHtml = `<option value="">${placeholder}</option>`;
                    
                    if (Array.isArray(options)) {
                        options.forEach(option => {
                            const isSelected = option === value ? 'selected' : '';
                            optionsHtml += `<option value="${option}" ${isSelected}>${option}</option>`;
                        });
                    } else if (typeof options === 'object') {
                        Object.entries(options).forEach(([key, label]) => {
                            const isSelected = key === value ? 'selected' : '';
                            optionsHtml += `<option value="${key}" ${isSelected}>${label}</option>`;
                        });
                    }
                    
                    return `
                        <select 
                            data-tab="${tabName}"
                            data-field="${field}"
                            class="w-full p-3 border border-slate-200 rounded-xl bg-white text-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all"
                        >
                            ${optionsHtml}
                        </select>
                    `;
                };
                
                const InputWrap = (label, children) => `
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">${label}</label>
                        ${children}
                    </div>
                `;
                
                switch (tab) {
                    case "ice_breaking":
                        const transactionOptions = ["ฝากประจำ", "มาปรับสมุด", "ถอนเงินก้อน", "เปิดบัญชีนิติบุคคล", "อื่นๆ"];
                        const discOptions = {
                            "D": "D - เน้นเป้าหมาย (Direct)",
                            "I": "I - ชอบคุย (Influential)",
                            "S": "S - เน้นความมั่นคง (Steady)",
                            "C": "C - เน้นข้อมูล (Conscientious)"
                        };
                        const relationshipOptions = ["ใหม่", "พอคุ้นเคย", "สนิท"];
                        
                        return `
                            <div class="space-y-4 animate-in">
                                ${InputWrap("ธุรกรรมอ้างอิง", 
                                    createSelect('ice_breaking', 'transaction', f.transaction, transactionOptions, "เลือกธุรกรรม")
                                )}
                                ${InputWrap("สิ่งสังเกตเชิงลึก (Insight)", 
                                    createTextarea('ice_breaking', 'insight', f.insight, "เช่น: มากับลูกเล็ก, ดูเป็นห่วงคุณแม่ที่เดินไม่ค่อยไหว, ใส่ชุดข้าราชการ...", 3)
                                )}
                                <div class="grid grid-cols-2 gap-4">
                                    ${InputWrap("จริตลูกค้า (DISC)", 
                                        createSelect('ice_breaking', 'disc', f.disc, discOptions)
                                    )}
                                    ${InputWrap("ระดับความสัมพันธ์", 
                                        createSelect('ice_breaking', 'relationship_level', f.relationship_level, relationshipOptions)
                                    )}
                                </div>
                                ${InputWrap("ความสนใจร่วม (ถ้ารู้)", 
                                    createInput('ice_breaking', 'common_interest', f.common_interest, "เช่น: กอล์ฟ, ลงทุน, ท่องเที่ยว")
                                )}
                            </div>
                        `;
                        
                    case "needs_analysis":
                        const taxOptions = ["10%", "20%", "30%", "ไม่เสียเลย"];
                        const welfareOptions = ["บัตรทอง/ประกันสังคม", "ประกันกลุ่มบริษัท", "มีเล่มประกันส่วนตัว", "ไม่มี"];
                        const concernOptions = ["กลัวเงินหมดก่อนตาย", "กลัวเป็นโรคร้ายแล้วถังแตก", "กลัวลูกลำบากถ้าตัวเองไม่อยู่", "อื่นๆ"];
                        
                        return `
                            <div class="space-y-4 animate-in">
                                ${InputWrap("รายได้ต่อปี (บาท)", 
                                    createInput('needs_analysis', 'income', f.income, "เช่น: 600000", "number")
                                )}
                                <div class="grid grid-cols-2 gap-4">
                                    ${InputWrap("สถานะทางภาษี", 
                                        createSelect('needs_analysis', 'tax_bracket', f.tax_bracket, taxOptions)
                                    )}
                                    ${InputWrap("คนในอุปการะ", 
                                        createInput('needs_analysis', 'dependents', f.dependents, "คน", "number")
                                    )}
                                </div>
                                ${InputWrap("สวัสดิการปัจจุบัน", 
                                    createSelect('needs_analysis', 'welfare', f.welfare, welfareOptions)
                                )}
                                ${InputWrap("ความกังวลอันดับหนึ่ง", 
                                    createSelect('needs_analysis', 'top_concern', f.top_concern, concernOptions)
                                )}
                                <div class="grid grid-cols-2 gap-4">
                                    ${InputWrap("จำนวนปีที่ต้องดูแล", 
                                        createInput('needs_analysis', 'years', f.years, "ปี", "number")
                                    )}
                                    ${InputWrap("สินทรัพย์ที่มี", 
                                        createInput('needs_analysis', 'assets', f.assets, "บาท", "number")
                                    )}
                                </div>
                                ${InputWrap("หนี้สินรวม", 
                                    createInput('needs_analysis', 'debt', f.debt, "บาท", "number")
                                )}
                                <div class="mt-6 p-4 bg-gradient-to-r from-sky-50 to-indigo-50 rounded-xl border border-sky-100">
                                    <div class="flex items-center gap-2 mb-2">
                                        ${ICONS.alert}
                                        <span class="text-sm font-bold text-sky-800">Protection Gap</span>
                                    </div>
                                    <div class="text-2xl font-black text-sky-900">${this.calculateProtectionGap().toLocaleString()} บาท</div>
                                    <p class="text-xs text-sky-600 mt-1">ส่วนต่างที่ต้องปิดด้วยการวางแผน</p>
                                </div>
                            </div>
                        `;
                        
                    case "objection":
                        const reasonOptions = ["ไม่มีสภาพคล่อง", "ไม่เชื่อมั่นในตัวแทน", "รู้สึกว่าเบี้ยทิ้งสูญเปล่า", "ขอไปเปรียบเทียบกับคู่แข่ง", "อื่นๆ"];
                        const toneOptions = ["กังวล", "ไม่มั่นใจ", "สงสัย", "ปฏิเสธ", "เหนื่อย"];
                        const productOptions = ["ประกันชีวิต", "ประกันสุขภาพ", "ประกันโรคร้ายแรง", "ประกันอุบัติเหตุ", "กองทุนรวม"];
                        
                        return `
                            <div class="space-y-4 animate-in">
                                ${InputWrap("สาเหตุที่แท้จริงของการปฏิเสธ", 
                                    createSelect('objection', 'real_reason', f.real_reason, reasonOptions)
                                )}
                                <div class="grid grid-cols-2 gap-4">
                                    ${InputWrap("ระดับความสนใจเดิม (1-10)", 
                                        createInput('objection', 'interest_level', f.interest_level, "5", "number", "text-center")
                                    )}
                                    ${InputWrap("จริตลูกค้า", 
                                        createSelect('objection', 'disc', f.disc, {
                                            "D": "D - เน้นเป้าหมาย",
                                            "I": "I - ชอบคุย", 
                                            "S": "S - เน้นความมั่นคง",
                                            "C": "C - เน้นข้อมูล"
                                        })
                                    )}
                                </div>
                                ${InputWrap("น้ำเสียงลูกค้า", 
                                    createSelect('objection', 'tone', f.tone, toneOptions)
                                )}
                                ${InputWrap("แบบประกันที่เสนอ", 
                                    createSelect('objection', 'product', f.product, productOptions)
                                )}
                                <div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-100">
                                    <p class="text-xs text-amber-800">
                                        <strong>เคล็ดลับ:</strong> AI จะยกตัวอย่างเคสจริงในพื้นที่ ${this.state.userProfile.zone} เพื่อสร้างความน่าเชื่อถือ
                                    </p>
                                </div>
                            </div>
                        `;
                        
                    default:
                        return `<div class="text-center text-slate-500 p-8">เลือกรายการเมนูเพื่อเริ่มต้น</div>`;
                }
            }
            
            calculateProtectionGap() {
                const f = this.state.forms.needs_analysis;
                const income = parseFloat(f.income) || 0;
                const debt = parseFloat(f.debt) || 0;
                const dependents = parseInt(f.dependents) || 0;
                const years = parseInt(f.years) || 5;
                const assets = parseFloat(f.assets) || 0;
                
                const monthlyNeed = (income * 0.7) / 12;
                const totalNeed = debt + (monthlyNeed * 12 * years);
                const gap = Math.max(0, totalNeed - assets);
                
                return gap;
            }
            
            renderMainPage() {
                const tabs = [
                    { id: 'ice_breaking', label: '1. เปิดใจ', icon: ICONS.message, desc: 'Contextual Bridge' },
                    { id: 'needs_analysis', label: '2. วิเคราะห์ความต้องการ', icon: ICONS.calculator, desc: 'Human Economic Value' },
                    { id: 'objection', label: '3. ทลายข้อโต้แย้ง', icon: ICONS.shield, desc: 'Reframing & Empathy' },
                    { id: 'simplifier', label: '4. ย่อยผลประโยชน์', icon: ICONS.gift, desc: 'Simplify & Compare' },
                    { id: 'matchmaker', label: '5. เลือกผลิตภัณฑ์', icon: ICONS.bag, desc: 'Product Matching' },
                    { id: 'closing', label: '6. สรุปและปิดการขาย', icon: ICONS.file, desc: 'Closing Techniques' },
                    { id: 'prompt_designer', label: '7. Prompt Designer', icon: ICONS.terminal, desc: 'AI Prompt Engineering' },
                ];
                
                const rh = RH_DATA[this.state.userProfile.rh] || {};
                const zone = this.state.userProfile.zone;
                
                return `
                    <div class="min-h-screen flex flex-col md:flex-row bg-white">
                        <!-- Sidebar -->
                        <aside class="w-full md:w-72 bg-gradient-to-b from-slate-900 to-slate-950 text-white flex flex-col">
                            <div class="p-6 border-b border-white/10">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-sky-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
                                        ${ICONS.sparkles.replace('text-amber-500', 'text-white')}
                                    </div>
                                    <div>
                                        <span class="font-black text-xl block leading-none">MAMA <span class="bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">V.2</span></span>
                                        <span class="text-xs text-slate-400">Enhanced AI Assistant</span>
                                    </div>
                                </div>
                                <div class="text-sm opacity-75">
                                    <div class="flex items-center gap-2">
                                        ${ICONS.map}
                                        <span>${zone}</span>
                                    </div>
                                    <div class="flex items-center gap-2 mt-1 text-xs text-slate-400">
                                        ${ICONS.lock}
                                        <span>รหัสผ่าน: ตรวจสอบแล้ว</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-4 space-y-1 custom-scrollbar">
                                ${tabs.map((tab) => `
                                    <button
                                        data-tab-id="${tab.id}"
                                        class="w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all group text-left ${this.state.activeTab === tab.id ? 'bg-gradient-to-r from-sky-600 to-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                                        ${tab.icon}
                                        <div class="flex-1">
                                            <div class="text-sm font-bold">${tab.label}</div>
                                            <div class="text-xs opacity-75">${tab.desc}</div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div class="p-4 border-t border-white/10 space-y-2">
                                <button id="change-zone-btn" 
                                        class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-white py-3 rounded-lg hover:bg-white/5 transition-colors">
                                    ${ICONS.rotate}
                                    <span>เปลี่ยนพื้นที่</span>
                                </button>
                                
                                <button id="logout-main-btn" 
                                        class="w-full flex items-center justify-center gap-2 text-rose-400 hover:text-rose-300 py-3 rounded-lg hover:bg-white/5 transition-colors border-t border-white/10 pt-3">
                                    ${ICONS.alert}
                                    <span>ออกจากระบบ</span>
                                </button>
                            </div>
                        </aside>
                        
                        <!-- Main Content -->
                        <main class="flex-1 flex flex-col min-h-screen">
                            <!-- Header -->
                            <header class="bg-white border-b px-6 py-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h2 class="text-xl font-black text-slate-800">
                                            ${this.state.activeTab === 'ice_breaking' ? 'เปิดใจ (Ice Breaking)' : 
                                              this.state.activeTab === 'needs_analysis' ? 'วิเคราะห์ความต้องการ (Needs Analysis)' :
                                              this.state.activeTab === 'objection' ? 'ทลายข้อโต้แย้ง (Objection Handling)' :
                                              this.state.activeTab.replace('_', ' ')}
                                        </h2>
                                        <p class="text-sm text-slate-600 mt-1">
                                            ${this.state.activeTab === 'ice_breaking' ? 'Contextual Bridge - สร้างสะพานเชื่อมโยงจากสิ่งที่เห็นสู่ความกังวลลึกๆ' :
                                              this.state.activeTab === 'needs_analysis' ? 'Human Economic Value - ทำให้ลูกค้าเห็นว่าตัวเขาคือทรัพย์สินที่แพงที่สุด' :
                                              this.state.activeTab === 'objection' ? 'Reframing & Empathy - เปลี่ยนมุมมองจาก "ค่าใช้จ่าย" เป็น "การป้องกันความมั่งคั่ง"' :
                                              'กรอกข้อมูลเพื่อรับคำแนะนำจาก AI'}
                                        </p>
                                    </div>
                                    <button 
                                        id="generate-ai-btn"
                                        ${this.state.loading ? 'disabled' : ''}
                                        class="px-6 py-3 rounded-xl font-bold transition-all flex items-center gap-2 ${this.state.loading ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-sky-600 to-indigo-600 text-white hover:from-sky-700 hover:to-indigo-700 shadow-lg active:scale-95 transform transition-transform'}"
                                        style="min-width: 140px;">
                                        ${this.state.loading ? ICONS.loader : ICONS.sparkles.replace('text-amber-500', 'text-white')}
                                        <span>${this.state.loading ? 'กำลังวิเคราะห์...' : 'วิเคราะห์ด้วย AI'}</span>
                                    </button>
                                </div>
                            </header>
                            
                            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                                <!-- Left: Input Panel -->
                                <div class="w-full md:w-96 bg-slate-50 border-r overflow-y-auto p-6">
                                    <div class="mb-6">
                                        <h3 class="text-lg font-bold text-slate-800 mb-2">กรอกข้อมูลลูกค้า</h3>
                                        <p class="text-sm text-slate-600">กรอกข้อมูลเพื่อให้ AI วิเคราะห์และสร้างบทสนทนาเฉพาะบุคคล</p>
                                    </div>
                                    
                                    <div id="input-section" class="mb-8">
                                        ${this.renderInputSection()}
                                    </div>
                                    
                                    <!-- Zone Insights -->
                                    <div class="bg-white rounded-xl border p-4">
                                        <div class="flex items-center gap-2 mb-3">
                                            ${ICONS.building}
                                            <h4 class="font-bold text-slate-800">ข้อมูลพื้นที่ ${zone}</h4>
                                        </div>
                                        <p class="text-sm text-slate-600 mb-3">${rh.dynamics || 'กรุณาเลือกภูมิภาค'}</p>
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2">
                                                ${ICONS.hospital}
                                                <span class="text-xs font-medium text-slate-700">โรงพยาบาลหลัก:</span>
                                            </div>
                                            <div class="flex flex-wrap gap-1.5">
                                                ${rh.hospitals ? rh.hospitals.map(h => `
                                                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-lg">${h}</span>
                                                `).join('') : '<span class="text-xs text-slate-400">กรุณาเลือกภูมิภาค</span>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Output Panel -->
                                <div class="flex-1 overflow-y-auto bg-white">
                                    ${this.renderOutputPanel()}
                                </div>
                            </div>
                        </main>
                    </div>
                `;
            }
            
            renderOutputPanel() {
                if (!this.state.aiResponse) {
                    return `
                        <div class="h-full flex flex-col items-center justify-center p-8 text-center">
                            <div class="w-32 h-32 bg-gradient-to-br from-slate-100 to-slate-200 rounded-full flex items-center justify-center mb-6">
                                ${ICONS.lightbulb}
                            </div>
                            <h3 class="text-2xl font-black text-slate-800 mb-4">พร้อมวิเคราะห์ข้อมูลลูกค้า</h3>
                            <p class="text-slate-600 max-w-md mb-8">
                                กรอกข้อมูลลูกค้าในช่องทางซ้ายมือ แล้วกดปุ่ม "วิเคราะห์ด้วย AI" 
                                เพื่อรับคำแนะนำเฉพาะบุคคลตามพื้นที่ ${this.state.userProfile.zone}
                            </p>
                            <div class="flex items-center gap-2 text-sm text-slate-500">
                                ${ICONS.zap}
                                <span>ระบบใช้ Supabase API Key Rotation สำหรับความเสถียร</span>
                            </div>
                        </div>
                    `;
                }
                
                // Simple formatting
                const formattedResponse = this.state.aiResponse
                    .replace(/### (.*?)(\n|$)/g, '<h3 class="text-xl font-black text-slate-900 mt-8 mb-4 pb-2 border-b">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900">$1</strong>')
                    .replace(/\n/g, '<br>');
                
                return `
                    <div class="max-w-3xl mx-auto p-6 md:p-8">
                        <div class="bg-gradient-to-br from-white to-slate-50 rounded-2xl shadow-lg overflow-hidden border border-slate-200">
                            <div class="bg-gradient-to-r from-sky-600 to-indigo-600 px-6 py-4 text-white">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                            ${ICONS.lightbulb.replace('text-amber-500', 'text-white')}
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold opacity-90">AI SUGGESTION</div>
                                            <div class="text-lg font-black">${this.state.activeTab.replace('_', ' ').toUpperCase()}</div>
                                        </div>
                                    </div>
                                    <button id="copy-btn" 
                                            class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-lg flex items-center justify-center transition-colors">
                                        ${ICONS.copy.replace('text-slate-500', 'text-white')}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6 md:p-8 text-slate-700 leading-relaxed">
                                ${formattedResponse}
                            </div>
                            
                            <div class="border-t border-slate-200 p-4 bg-slate-50">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-slate-600">
                                        คำแนะนำนี้ปรับให้เหมาะกับพื้นที่: <span class="font-bold">${this.state.userProfile.zone}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="feedback-up-btn" 
                                                class="w-10 h-10 rounded-full flex items-center justify-center border ${this.state.feedback === 'up' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-white text-slate-400 border-slate-300 hover:border-emerald-500 hover:text-emerald-500'}">
                                            ${ICONS.thumbsUp}
                                        </button>
                                        <button id="feedback-down-btn" 
                                                class="w-10 h-10 rounded-full flex items-center justify-center border ${this.state.feedback === 'down' ? 'bg-rose-500 text-white border-rose-500' : 'bg-white text-slate-400 border-slate-300 hover:border-rose-500 hover:text-rose-500'}">
                                            ${ICONS.thumbsDown}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${this.state.error ? `
                            <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600">
                                <div class="flex items-center gap-2">
                                    ${ICONS.alert}
                                    <strong>หมายเหตุ:</strong> ${this.state.error}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            renderError(error) {
                const root = document.getElementById('root');
                if (!root) return;
                
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-red-50 p-4">
                        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">เกิดข้อผิดพลาด</h1>
                            <p class="text-slate-600 mb-2">ระบบไม่สามารถแสดงผลได้:</p>
                            <pre class="text-xs text-slate-500 bg-slate-100 p-3 rounded mb-4 overflow-auto max-h-40">${error.message}</pre>
                            <div class="flex gap-2">
                                <button onclick="location.reload()" class="flex-1 bg-sky-600 text-white py-3 rounded-lg font-bold">
                                    รีเฟรชหน้าเว็บ
                                </button>
                                <button onclick="app.logout()" class="px-4 py-3 bg-slate-200 text-slate-700 rounded-lg font-medium">
                                    ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ========== EVENT LISTENERS ==========
            
            attachEventListeners() {
                // Passcode submit
                const passcodeBtn = document.getElementById('submit-passcode-btn');
                if (passcodeBtn) {
                    passcodeBtn.onclick = () => this.submitPasscode();
                }
                
                // Passcode input Enter key
                const passcodeInput = document.getElementById('passcode-input');
                if (passcodeInput) {
                    passcodeInput.onkeyup = (e) => {
                        if (e.key === 'Enter') this.submitPasscode();
                    };
                }
                
                // Setup page buttons
                const startBtn = document.getElementById('start-system-btn');
                if (startBtn) {
                    startBtn.onclick = () => {
                        if (this.state.userProfile.zone) {
                            this.setState({ isSetup: true });
                        } else {
                            alert('กรุณาเลือกโซนให้ครบ');
                        }
                    };
                }
                
                // RH and Zone select
                const rhSelect = document.getElementById('rh-select');
                if (rhSelect) {
                    rhSelect.onchange = (e) => {
                        const rh = e.target.value;
                        this.setState({ 
                            userProfile: { ...this.state.userProfile, rh, zone: "" } 
                        });
                    };
                }
                
                const zoneSelect = document.getElementById('zone-select');
                if (zoneSelect) {
                    zoneSelect.onchange = (e) => {
                        const zone = e.target.value;
                        this.setState({ 
                            userProfile: { ...this.state.userProfile, zone } 
                        });
                    };
                }
                
                // Logout buttons
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.onclick = () => this.logout();
                
                const logoutMainBtn = document.getElementById('logout-main-btn');
                if (logoutMainBtn) logoutMainBtn.onclick = () => this.logout();
                
                // Non-AI button
                const nonAIBtn = document.getElementById('non-ai-btn');
                if (nonAIBtn) nonAIBtn.onclick = () => this.showNonAIPopup();
                
                // Tab switching
                document.querySelectorAll('[data-tab-id]').forEach(button => {
                    button.onclick = (e) => {
                        const tabId = e.currentTarget.dataset.tabId;
                        if (tabId) {
                            this.setState({ activeTab: tabId });
                        }
                    };
                });
                
                // Change zone button
                const changeZoneBtn = document.getElementById('change-zone-btn');
                if (changeZoneBtn) changeZoneBtn.onclick = () => this.setState({ isSetup: false });
                
                // Generate button
                const generateBtn = document.getElementById('generate-ai-btn');
                if (generateBtn) {
                    generateBtn.onclick = () => this.handleGenerate();
                }
                
                // Form inputs
                document.querySelectorAll('[data-tab][data-field]').forEach(element => {
                    element.onchange = element.oninput = (e) => {
                        const tab = e.target.dataset.tab;
                        const field = e.target.dataset.field;
                        const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                        
                        if (tab && field) {
                            this.setState({
                                forms: {
                                    ...this.state.forms,
                                    [tab]: {
                                        ...this.state.forms[tab],
                                        [field]: value
                                    }
                                }
                            });
                        }
                    };
                });
                
                // Copy button
                const copyBtn = document.getElementById('copy-btn');
                if (copyBtn) {
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(this.state.aiResponse)
                            .then(() => alert('คัดลอกแล้ว!'))
                            .catch(() => alert('ไม่สามารถคัดลอกได้'));
                    };
                }
                
                // Feedback buttons
                const feedbackUpBtn = document.getElementById('feedback-up-btn');
                if (feedbackUpBtn) {
                    feedbackUpBtn.onclick = () => this.setState({ feedback: 'up' });
                }
                
                const feedbackDownBtn = document.getElementById('feedback-down-btn');
                if (feedbackDownBtn) {
                    feedbackDownBtn.onclick = () => this.setState({ feedback: 'down' });
                }
                
                // Non-AI popup buttons
                const cancelNonAIBtn = document.getElementById('cancel-non-ai');
                if (cancelNonAIBtn) {
                    cancelNonAIBtn.onclick = () => this.hideNonAIPopup();
                }
                
                const confirmNonAIBtn = document.getElementById('confirm-non-ai');
                if (confirmNonAIBtn) {
                    confirmNonAIBtn.onclick = () => this.goToNonAISystem();
                }
            }
            
            // ========== AI GENERATION ==========
            
            async handleGenerate() {
                if (this.state.loading) return;
                
                this.setState({ loading: true, aiResponse: "", error: "" });
                
                try {
                    // Get API key
                    const apiKey = await getRotatedApiKey();
                    
                    if (!apiKey) {
                        // Demo mode
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        this.showMockResponse();
                        return;
                    }
                    
                    const prompt = this.getEnhancedPrompt();
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 2048,
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || "API Error");
                    }
                    
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ไม่พบคำตอบจาก AI";
                    this.setState({ aiResponse: aiText, loading: false });
                    
                } catch (err) {
                    console.error("Error:", err);
                    this.setState({ 
                        error: err.message + " - กำลังใช้โหมดทดลอง", 
                        loading: false 
                    });
                    this.showMockResponse();
                }
            }
            
            showMockResponse() {
                const mockResponses = {
                    ice_breaking: `### 🧠 การวิเคราะห์จริตลูกค้า (DISC: ${this.state.forms.ice_breaking.disc})
- **จุดเข้าหาที่ได้ผล:** 
  1. พูดตรงประเด็น เน้นผลลัพธ์และตัวเลข
  2. ให้ทางเลือกที่ชัดเจนและวัดผลได้
  3. เคารพเวลาและตัดสินใจเร็ว
- **สิ่งที่ต้องเลี่ยง:**
  - การพูดเยินเย้อ ไม่ตรงประเด็น
  - การบังคับหรือกดดันเกินไป

### 💬 บทสนทนาเปิดใจ (Contextual Bridge)
1. **Opening Hook:** "สวัสดีครับ/คะ เห็นคุณมา${this.state.forms.ice_breaking.transaction || "ทำธุรกรรม"} ที่นี่ ผมสังเกตเห็นว่าคุณ${this.state.forms.ice_breaking.insight || "เป็นคนรายละเอียดดี"} เลยอยากคุยเรื่องหนึ่งที่สำคัญ"
2. **Empathy Bridge:** "ลูกค้าหลายท่านใน${this.state.userProfile.zone} ที่มา${this.state.forms.ice_breaking.transaction || "ทำธุรกรรม"} มักจะมีคำถามเรื่องการวางแผนรับมือความไม่แน่นอน ผมเข้าใจว่าทุกคนอยากเตรียมการไว้ดีที่สุด"
3. **Open Question:** "ถ้ามีหนึ่งสิ่งที่คุณอยากทำให้ครอบครัวมั่นใจได้ 100% ในปีนี้ จะเป็นเรื่องอะไรครับ/คะ?"

### 🎯 คำถามทรงพลัง (Power Question)
"ถ้าวันนี้คุณหยุดทำงานได้ 1 ปี โดยครอบครัวยังใช้ชีวิตได้ตามปกติ คุณรู้สึกว่าต้องเตรียมตัวอย่างไรบ้าง?"`
                };
                
                this.setState({ 
                    aiResponse: mockResponses[this.state.activeTab] || "กำลังประมวลผล...", 
                    loading: false 
                });
            }
            
            getEnhancedPrompt() {
                const tab = this.state.activeTab;
                const f = this.state.forms[tab];
                const rh = RH_DATA[this.state.userProfile.rh] || {};
                const zone = this.state.userProfile.zone;
                
                if (tab === "ice_breaking") {
                    return `คุณเป็นผู้เชี่ยวชาญการขายประกันชีวิตในพื้นที่ ${zone} (${rh.name})
ข้อมูลลูกค้า:
- ธุรกรรม: ${f.transaction}
- สิ่งสังเกต: ${f.insight}
- จริต: ${f.disc}
- ระดับความสัมพันธ์: ${f.relationship_level}
- ความสนใจร่วม: ${f.common_interest}

ข้อมูลพื้นที่ ${zone}:
- ลักษณะสังคม: ${rh.dynamics}
- น้ำเสียงที่ได้ผล: ${rh.tone}
- คอนเท็กซ์: ${rh.context}

กรุณาสร้างบทสนทนาเปิดใจ (Ice Breaking) ที่:
1. เชื่อมโยงจากธุรกรรมที่ลูกค้ามาทำสู่ความกังวลลึกๆ
2. ใช้คำพูดที่เหมาะกับจริต ${f.disc}
3. สอดแทรกข้อมูลเฉพาะพื้นที่ ${zone}
4. สร้างคำถามทรงพลัง 1-2 คำถามเพื่อสำรวจความต้องการ
5. ใช้ภาษาไทยแบบเป็นกันเองแต่เชี่ยวชาญ`;
                }
                
                if (tab === "needs_analysis") {
                    return `คุณเป็นที่ปรึกษาการเงินในพื้นที่ ${zone} (${rh.name})
ข้อมูลลูกค้า:
- รายได้ต่อปี: ${f.income} บาท
- ภาษี: ${f.tax_bracket}
- สวัสดิการ: ${f.welfare}
- ความกังวลหลัก: ${f.top_concern}
- คนในอุปการะ: ${f.dependents} คน
- จำนวนปีที่ต้องดูแล: ${f.years} ปี
- สินทรัพย์: ${f.assets} บาท
- หนี้สิน: ${f.debt} บาท

ข้อมูลพื้นที่ ${zone}:
- ลักษณะสังคม: ${rh.dynamics}
- คีย์เวิร์ดสำคัญ: ${rh.keywords}
- โทนการสื่อสาร: ${rh.tone}

กรุณาวิเคราะห์ Human Economic Value และสร้างแผนการคุ้มครองที่เหมาะสม:
1. คำนวณมูลค่าคน (Human Economic Value)
2. ระบุช่องว่างความคุ้มครอง (Protection Gap)
3. เสนอแผนประกันที่เหมาะกับพื้นที่ ${zone}
4. อธิบายด้วยภาษาง่ายๆ
5. เน้นประโยชน์ด้านภาษีและผลตอบแทน`;
                }
                
                return "โปรดกรอกข้อมูลในฟอร์มเพื่อรับคำแนะนำจาก AI";
            }
            
            // ========== NON-AI POPUP ==========
            
            showNonAIPopup() {
                const popup = document.getElementById('non-ai-popup');
                if (popup) popup.classList.remove('hidden');
            }
            
            hideNonAIPopup() {
                const popup = document.getElementById('non-ai-popup');
                if (popup) popup.classList.add('hidden');
            }
            
            goToNonAISystem() {
                window.location.href = "https://pltpdttb-jpg.github.io/sales-assist/";
            }
            
            // ========== INITIALIZATION ==========
            
            init() {
                // Load saved state
                try {
                    const savedState = localStorage.getItem('mama_v2_state');
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        this.state = { ...this.state, ...parsed };
                    }
                } catch (e) {
                    console.log("No saved state found");
                }
                
                // Initial render
                this.render();
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.app = new MAMAV2Enhanced();
            console.log("MAMA V.2 Enhanced App loaded successfully!");
        });
    </script>
</body>
</html>
